name: "Terraform"
on:
    push:
        branches:
            - main

jobs:
    terraform:
        runs-on: ubuntu-latest
        env:
            TF_VAR_bucket_name: "learn-terraform-396505-bitbucket"
            TF_VAR_project_id: "learn-terraform-396505" # your project id
            TF_VAR_region: "australia-southeast2"
            TF_VAR_zone: "australia-southeast2-a"
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: "Authenticate to Google Cloud"
              id: auth
              uses: google-github-actions/auth@v0
              with:
                  credentials_json: ${{secrets.GCP_SA_KEY}}

            - name: "Storing SA Key to json file"
              id: sa-config
              run: |
                  echo "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAi
                  bGVhcm4tdGVycmFmb3JtLTM5NjUwNSIsCiAgInByaXZhdGVfa2V5X2lkIjogImI5
                  ZjRkNTg3ZWRjNjkzMDMxMzA4YmQ2MDU3N2YzMmFkNjE2MTk3NzciLAogICJwcml2
                  YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lC
                  QURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRREI1V1Az
                  MU1IZkxBNHpcblRSUHQ1bFRkL01IWDV3SG9JUjJhSTJybnBtUnluZVo3LzhnM1do
                  YUVLS3p0eWlNa1NuKzdpdmJHOHROMW8zUytcbi9SOTQ0U2NXS0MwZWNPT3NldGls
                  aTdhQUxGSWdtRTNleHA1d2dvVDlxeGljT2JvS0N1Q0NvNmVmK0R6MUlhZU5cbjlC
                  SnJUQWRpMVNJK3lWU2c3ekFLaGt1ckd4NTNGaUNpaktBK2YrUE9xV1dGelJQeXRI
                  RUpkQzltTUNBazQvR3FcbjdzOEhEeGRtU05IVmRlZC81SGdMbHdHVXVBWStvdmRz
                  cGZxUmVQd3ZvdmtZMVRDZUREZ1BxRXBncVJwbmNnQjRcbmJBd29GRlRjNWdudmMz
                  TWVPdDBtTTJkRmNRSUdCMjl6TjhaTnk3dmhJUy9wciswcjNsS05QOGxBM05ybHVU
                  QlNcbnFvcEJ3YUdkQWdNQkFBRUNnZ0VBR3Nmd1V0N1VHRnNoYXZ5T2NDR01QMDBX
                  Q1JnakwwakRxZktTWllTYUF5ckVcbkZ3UnhSeFB1WURxdUIvb1BlSWZCdE1tdzVE
                  SE4rMFdrYm16UDJBWmhPN0k0NlNkMml2QTgxRURENkZnMno4RzVcbm43ZVhVcnIw
                  VzRVeVZRRzBMSWJzRTU4L0c5MVJyaG9ENXB0N244NVVodFloY01LbUtjUmZ3bFJp
                  UnpQcnRVN2ZcbkpoN1I0RHBvTkIvaGRiY0RVeGhlU0Ztdm5yZ2NBNzNxMG1Na0hM
                  akxpUTZ1OFA1Y1JBOWhkbHBEZmluYms4RGNcbnloQlROc1lZVG0xUDMyZGc5NXJY
                  eW5mK3pFdHlpMDZRSUZUaE5WbVBrWUNEdjI5ZEQxNVBzUTdDUE83U2dncFFcbklz
                  L3h0UTFXMXRBTGdNV0c5UGJuMTV3Yy9xM3J5cjJnVUFxYXZKcWdrUUtCZ1FENkVv
                  aytsUlR6QnNjek4vcytcbm1GSFBoR1JiaFdoaHFiODlvSmpYU0xEL00yNGFSNHMx
                  ZzJXOFNYSXUvMnJiRXRpL3pKbi85bTVCU2JzangwQWtcbi8wY21DTUhGYTFQVjBB
                  OEg5QjFMVHp1eHozT3ZwTnZ2MmplM0NiSWg2dUVLWFhZcE1tbTlKaG1WcndMNFYw
                  VVlcblptU3B3elV6UTF5VEVDNmthWnBua2xNcnN3S0JnUURHZmZpRmpKQWxiTkQw
                  OGhBRnRlbFNwdU1JQkU4VGpmc0FcblJ3Y3BvcUJneGFCMVJkSGlyS091bGtKb3I5
                  anczZFc5bURXdmhFUldGdlNxRmNLOHNESkFtTll4azk2aUxpWmFcbkxKdWlXb1Yy
                  OWVvZHFJS1NIdXpqMXFOWFdXYXhZa3ROV1IvUFVnZ0RkbDBNY3RPWGdEREkyR2pO
                  SGFpMWk3NS9cblRuUHlFSFFWYndLQmdFbk00SjRNaHpNMW8rSVV1bHY5dmQ4ZE5q
                  VGdTUzdSVnJRTVNpNzJyKzJRc3dTa2FvdnZcbmJEM0YreUd0bFU1ejRHMnlKeHlv
                  RUYvS0w2VmVieXE3LzdaVXpVTEM2dW5semhuTnpEdG1kYnFDKzZReFpnc0Jcbi9v
                  RlJKalhtU0dXenNXUjFFVW1XRGVUajBsK1IrYjA2c3FoN0NKOUpXTys1emRvTnBG
                  aStrVGNMQW9HQkFMUTVcbkVwcW51d1hRSEpZYTUwTllIV2JIVXFJbnoyalE1Rk1u
                  S3JDNkVXWnNham13MEZaQkxFbEw4elk4Vy95dlh1L0xcbnNRc1JURDdpanZtVDBv
                  SWlkUzVEMTAraWxHV3JBM1dpeFJrUG1ka2VoWml5TlFQWmdudUltanlvVnQ2K2dl
                  TFVcbkJsYm1nNUlwT1draEpVK012RDdRaDYrZHUxNURhUThNTzZoUkdpV1BBb0dC
                  QU1UMUt4WDVUVmhGYU9FU1diSmpcblVlTUgrN2hVQVdPWWtuNHhKMTRmemNkOGNY
                  UXNoWkpFZm9lT1FzRkg0VUpGK0tXZDJjMmlONFhsTlJLRTVnWCtcbk5ZMjVwTnFU
                  Z00yUWd1TUlJbGtDT3QvWVBkNk9WaGRzNlowSXFXZDJZYXcrQXozWTFxRi8rQUNx
                  L3o0L1ZGR2VcbldZOVVkcktIWEVpcWU3T1htYjZtVUdmMFxuLS0tLS1FTkQgUFJJ
                  VkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogIjE1MTEwNzU4ODEz
                  OC1jb21wdXRlQGRldmVsb3Blci5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xp
                  ZW50X2lkIjogIjExMjYwNDE5Nzc4Mjg1NzI3Nzc0NSIsCiAgImF1dGhfdXJpIjog
                  Imh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAi
                  dG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2Vu
                  IiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3
                  Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5
                  X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3Yx
                  L21ldGFkYXRhL3g1MDkvMTUxMTA3NTg4MTM4LWNvbXB1dGUlNDBkZXZlbG9wZXIu
                  Z3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29n
                  bGVhcGlzLmNvbSIKfQo=" | base64 -d > credentials.json

            - name: Terraform Init
              id: tf_init
              run: terraform init -backend-config="bucket=${{ env.TF_VAR_bucket_name }}"

            - name: Terraform Validate
              id: tf_validate
              run: terraform validate

            - name: Terraform Plan
              id: terraform_plan
              run: terraform plan

            - name: Terraform Apply
              id: tf_apply
              run: terraform apply --auto-approve
